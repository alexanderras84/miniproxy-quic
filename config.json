{
  "log": {
    "level": "error",
    "output": "stderr"
  },

  // =========================================
  // INBOUNDS
  // =========================================
  "inbounds": [
    {
      "type": "tproxy",
      "tag": "tproxy-in-443",
      "listen": "0.0.0.0",
      "listen_port": 443,
      "sniff": true,
      "sniff_override_destination": true,
      "sniff_timeout": "100ms",
      "domain_strategy": "ipv4_only",
      "udp_disable_domain_unmapping": true,
      "udp_fragment": true
    },
    {
      "type": "tproxy",
      "tag": "tproxy-in-80",
      "listen": "0.0.0.0",
      "listen_port": 80,
      "sniff": true,
      "sniff_override_destination": true,
      "sniff_timeout": "100ms",
      "domain_strategy": "ipv4_only",
      "udp_disable_domain_unmapping": true,
      "udp_fragment": true
    }
  ],

  // =========================================
  // OUTBOUNDS
  // =========================================
  "outbounds": [
    {
      "type": "direct",
      "tag": "direct",
      "tcp_fast_open": true,
      "udp_fragment": true
    }
  ],

  // =========================================
  // RULE PROVIDERS â€” NEW
  // =========================================
  "rule_providers": {
    "allowed_clients": {
      "type": "file",
      "format": "text",
      "path": "/etc/sing-box/allowlist.acl",
      "reload": true
    }
  },

  // =========================================
  // ROUTING
  // =========================================
  "route": {
    "rules": [
      {
        // Only allow traffic from IPs in allowlist.acl on ports 80/443
        "inbound": ["tproxy-in-443", "tproxy-in-80"],
        "rule_set": "allowed_clients",
        "action": "direct"
      },
      {
        // Reject anything NOT in the allowlist on ports 80/443
        // (sing-box recommends "block" instead of "reject" for ACL)
        "inbound": ["tproxy-in-443", "tproxy-in-80"],
        "invert": true,
        "rule_set": "allowed_clients",
        "action": "block"
      }
    ],

    "auto_detect_interface": true,
    "final": "direct"
  }
}
